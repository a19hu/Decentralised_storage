version: '3'

services:
  # Blockchain node (using Ganache for Ethereum development)
  blockchain:
    image: trufflesuite/ganache-cli:latest
    ports:
      - "8545:8545"
    command: --deterministic --mnemonic "decentralized storage system" --host 0.0.0.0

  # Coordinator service - manages storage nodes and file metadata
  coordinator:
    build: ./coordinator
    ports:
      - "5001:5001"
    environment:
      - BLOCKCHAIN_URL=http://blockchain:8545
    volumes:
      - coordinator_data:/app/data
    depends_on:
      - blockchain

  # Storage node 1
  storage1:
    build: ./storage_node
    environment:
      - NODE_ID=node1
      - STORAGE_LIMIT_MB=1000
      - COORDINATOR_URL=http://coordinator:5001
    ports:
      - "6001:6000"
    volumes:
      - storage1_data:/app/storage

  # Storage node 2
  storage2:
    build: ./storage_node
    environment:
      - NODE_ID=node2
      - STORAGE_LIMIT_MB=1500
      - COORDINATOR_URL=http://coordinator:5001
    ports:
      - "6002:6000"
    volumes:
      - storage2_data:/app/storage

  # Client API
  client-api:
    build: ./client
    environment:
      - COORDINATOR_URL=http://coordinator:5001
      - BLOCKCHAIN_URL=http://blockchain:8545
    ports:
      - "5002:5002"
    volumes:
      - ./client:/app
    depends_on:
      - coordinator
      - blockchain

  # Web interface
  web:
    build: ./web
    ports:
      - "3000:3000"
    environment:
      - CLIENT_API_URL=http://client-api:5002
    volumes:
      - ./web:/app
    depends_on:
      - client-api

volumes:
  coordinator_data:
  storage1_data:
  storage2_data: 